<html>
  <head>
    <meta charset="utf-8" />
    <title>Mand - Redirect URL's</title>
    <link rel="shortcut icon" href="/admin/favicon.png" type="image/x-icon">
    <style>
     img {
       height: 24px;
       width: 24px;
     }

     #content {
       display: none;
     }
    </style>
  </head>
  <body>
    <h1>Mand</h1>

    <div id="login">
      <section>
        <a href="/auth/connect/login">Log in with CH Connect</a>
      </section>
    </div>

    <div id="content">
      <section id="search">
        <input type="text" name="search" value="" placeholder="Search"/>
      </section>

      <section id="links">
      </section>

      <section id="create">
        <form action="javascript:void(0);">
          <input id="name" name="Name" type="text" value="" placeholder="Name" required/>
          <span>→</span>
          <input id="url" name="Redirect" type="URL" value="" placeholder="URL" required/>
          <button class="submit">Create</button>
        </form>
      </section>

      <section id="update">
        <form action="javascript:void(0);">
          <input id="name" name="Name" type="text" value="" placeholder="Name" required/>
          <span>→</span>
          <input id="url" name="Redirect" type="URL" value="" placeholder="URL" required/>
          <button class="cancel">Cancel</button>
          <button class="submit">Save</button>
        </form>
      </section>
    </div>
  </body>
  <script>
   let updating;
   let auth;

   document.querySelector('#update').style.display = 'none';

   // Set correct errors on incoming requests
   const handleErrors = (r) => {
     if (r.ok) {
       return r;
     }
     if (r.status === 401) {
       throw new Error(`Unauthorized: must be logged in.\n${r.url}`);
     }
     throw new Error(`Network response was not ok.\n${r.url}`);
   }

   // Handle errors during request processing
   const catchErrors = (error) => {
     console.error(error);
     alert(error.message);
   }

   // Construct a basic config to be used for all fetch requests
   const getBasicFetchConfig = () => {
     let myHeaders = new Headers();

     if (auth) {
       myHeaders.set('X-Auth', auth);
     }

     return config = {
       headers: myHeaders,
     }
   }

   const checkLogin = function() {
     // If there are no fetch parameters in the url, we have no parameters to do authentication with
     if (!location.search) {
       return;
     }

     // Extract code from the search part of the url
     const code = location.search.split('code=')[1].split('&')[0];

     const url = `/auth/connect/callback?code=${code}`;
     fetch(url, {})
       .then(handleErrors)
       .then((r) => {
         return r.json();
       })
       .then((json) => {
         // Set authentication token and push logged in navigation state
         auth = json.token;
         history.pushState({}, "Mand admin page", "/admin");

         // Retrieve links now that we are authenticated
         updateLinks();

         // Show the links section
         document.querySelector("#login").style.display = 'none';
         document.querySelector("#content").style.display = 'block';
       })
       .catch((error) => {
         history.pushState({}, "Mand admin page", "/admin");
         catchErrors(error);
       });
   };

   // Render links on the page
   const renderLinks = function(links) {
     const linksEl = document.querySelector('#links');
     // Remove old links
     linksEl.querySelectorAll('div').forEach((l) => {
       linksEl.removeChild(l);
     });

     // Add each link to the dom, can be done better by first building link elements and then adding
     links.forEach((l) => {
       let link = document.createElement('div');
       link.innerHTML = `
         <span>${l.Name}</span>
         <span>→</span>
         <a href="${l.Redirect}">${l.Redirect}</a>
       `;
       link.classList.add('link')
       link.data = l;

       let edit = document.createElement('img');
       edit.src = '/admin/edit.svg';
       edit.onclick = (e) => {
         let data = e.composedPath().find((e) => { return e.classList && e.classList.contains('link'); }).data;
         updating = data;
         let fields = document.querySelector('#update').querySelectorAll('input');
         for (let i of fields) {
           i.value = data[i.name];
         }
         document.querySelector('#update').style.display = 'block';
       };
       link.appendChild(edit)

       let remove = document.createElement('img');
       remove.src = '/admin/delete.svg';
       remove.onclick = (e) => {
         let data = e.composedPath().find((e) => { return e.classList && e.classList.contains('link'); }).data;
         if (confirm(`Are you sure you want to delete this link?\n\n${data.Name}\n\n${data.Redirect}`)) {
           let config = getBasicFetchConfig();
           config.method = 'DELETE';

           fetch(`/link/${data.Name}`, config)
             .then(handleErrors)
             .then((r) => {
               updateLinks();
             })
             .catch(catchErrors);
         }
       };
       link.appendChild(remove)

       linksEl.appendChild(link);
     })
   };

   // Get all the links
   const updateLinks = function(search = '') {
     if (!auth) {
       return;
     }

     let config = getBasicFetchConfig();
     config.headers.set('X-Search', search);

     fetch('/link', config)
       .then(handleErrors)
       .then((r) => {
         return r.json();
       })
       .then((json) => {
         renderLinks(json);
       })
       .catch(catchErrors);
   };

   // The search action
   document.querySelector('#search').querySelector('input').addEventListener('input', (e) => {
     updateLinks(e.target.value);
   })

   // Create a new link action
   document.querySelector('#create').querySelector('.submit').onclick = (e) => {
     let form = document.querySelector('#create').querySelector('form');
     if (!form.reportValidity()) {
       return;
     }

     let data = {};
     let elements = form.querySelectorAll('input');
     for (let el of elements) {
       data[el.name] = el.value;
     }

     let config = getBasicFetchConfig();
     config.method = 'POST';
     config.body = JSON.stringify(data);
     config.headers.set('Content-Type', 'application/json');

     fetch('/link', config)
       .then(handleErrors)
       .then((r) => {
         form.reset();
         updateLinks();
       })
       .catch(catchErrors);
   }

   // Update a link action
   document.querySelector('#update').querySelector('.submit').onclick = (e) => {
     let form = document.querySelector('#update').querySelector('form');
     if (!form.reportValidity()) {
       return;
     }

     let data = {};
     let elements = form.querySelectorAll('input');
     for (let el of elements) {
       data[el.name] = el.value;
     }

     let config = getBasicFetchConfig();
     config.method = 'PATCH';
     config.body = JSON.stringify(data);
     config.headers.set('Content-Type', 'application/json');

     fetch(`/link/${updating.Name}`, config)
       .then(handleErrors)
       .then((r) => {
         document.querySelector('#update').style.display = 'none';
         form.reset();
         delete updating;
         updateLinks();
       })
       .catch(catchErrors);
   }

   // Update cancel action
   document.querySelector('#update').querySelector('.cancel').onclick = (e) => {
     document.querySelector('#update').style.display = 'none';
     let form = document.querySelector('#update').querySelector('form');
     form.reset();
     delete updating;
   }

   checkLogin();

   // Populate page with initial links
   updateLinks();
  </script>
</html>
